# PR Command

Create a pull request using the GitHub CLI based on the work done in the current branch. The PR title and description are automatically generated by analyzing commits, diffs, and any associated spec documents.

## Instructions

1. **Verify branch status**
   
   Ensure you're not on the default branch:
   ```bash
   git branch --show-current
   ```
   
   If on `main`, `master`, or default branch, inform the user and abort.

2. **Check for unpushed commits**
   
   Verify the branch has been pushed to remote:
   ```bash
   git status --short --branch
   ```
   
   If there are unpushed commits, push them first:
   ```bash
   git push --set-upstream origin $(git branch --show-current)
   ```

3. **Gather branch information**
   
   Extract the branch name and type:
   ```bash
   git branch --show-current
   ```
   
   Parse the branch name to identify the issue class (feature, bug, chore, etc.).

4. **Find associated spec document**
   
   Look for a related spec file in the `specs/` directory that matches the branch name:
   ```bash
   ls -1 specs/ | grep -i "keywords-from-branch-name"
   ```
   
   If found, read the spec to understand the feature context.

5. **Analyze commits on the branch**
   
   Get all commits that are on this branch but not on the base branch:
   ```bash
   git log origin/main..HEAD --oneline
   git log origin/main..HEAD --format="%s%n%b"
   ```
   
   Use this to understand what work was done.

6. **Review the changes**
   
   Get a summary of all changes:
   ```bash
   git diff origin/main...HEAD --stat
   git diff origin/main...HEAD --shortstat
   ```

7. **Generate PR title**
   
   Create a clear, concise title following conventional commit format:
   - Start with the issue class prefix: `feat:`, `fix:`, `chore:`, `docs:`, `refactor:`, `test:`, `perf:`
   - Summarize the main purpose in 50-72 characters
   - Use imperative mood (e.g., "Add webhook logging" not "Added webhook logging")
   
   Examples:
   - `feat: add webhook event logging with structured output`
   - `fix: correct signature verification for GitHub webhooks`
   - `chore: update dependencies to latest versions`
   - `docs: add API reference documentation`

8. **Generate PR description**
   
   Create a comprehensive description with these sections:
   
   ```markdown
   ## Summary
   <2-3 sentence overview of what this PR does and why>
   
   ## Changes
   <bullet list of key changes made, organized by file or functionality>
   
   ## Related
   <if there's a spec file, reference it; if there are related issues, mention them>
   
   ## Testing
   <describe how the changes were tested or what testing is needed>
   
   ## Notes
   <any additional context, caveats, or future considerations>
   ```
   
   Base the content on:
   - Commit messages and their bodies
   - The diff summary showing which files changed
   - The spec document if one exists
   - Branch name and type

9. **Check for existing PR**
   
   Verify there isn't already a PR for this branch:
   ```bash
   gh pr list --head $(git branch --show-current) --json number,title
   ```
   
   If a PR exists, inform the user and ask if they want to update it instead.

10. **Create the pull request**
    
    Use the GitHub CLI to create the PR:
    ```bash
    gh pr create --title "generated title" --body "generated description"
    ```
    
    This will open a PR against the default branch (main/master).

11. **Confirm success**
    
    Display the PR URL and details:
    ```bash
    gh pr view --web
    ```

## Report

Output only:
- The PR number and title
- The PR URL
- A brief confirmation message

Example output:
```
Created PR #42: feat: add webhook event logging
https://github.com/owner/repo/pull/42
```

## Notes

- The command assumes the default base branch (main/master) as determined by GitHub
- If you need a different base branch, use `gh pr create --base branch-name` manually
- The generated description should be comprehensive but concise
- Review the PR in your browser after creation to make any manual adjustments
- The command will fail gracefully if gh is not authenticated or the branch hasn't been pushed
